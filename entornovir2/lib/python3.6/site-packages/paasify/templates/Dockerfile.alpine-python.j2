# Base python-alpine configuration
FROM {{ from_image }}
ARG PYPI_INDEX_URL="https://pypi.python.org/simple"
ARG ARTIFACTORY_USER_PROFILE
ARG ARTIFACTORY_API_KEY
# Install required packages
RUN apk update && apk add --no-cache g++ make
{%- if environment_constants %}
# Application Constants
{%- for key, value in environment_constants.items() %}
ENV {{ key }} {{ value }}
{%- endfor %}
{%- endif %}
{%- if pre_install_packages %}
# Install custom packages
RUN apk update && apk add --no-cache {{ pre_install_packages|join(" ") }}
{%- endif %}
COPY . /opt/app/
WORKDIR /opt/app
{%- if pre_install_commands %}
# Run custom commands
RUN {{ pre_install_commands|join(" && ") }}
{%- endif %}
# Install pip packages in requirements.txt
RUN pip3 install --no-cache-dir --extra-index-url ${PYPI_INDEX_URL} -r requirements.txt || /bin/true
# Install dumb-init
RUN pip3 install dumb-init
{%- if post_install_commands %}
# Run custom commands
RUN {{ post_install_commands|join(" && ") }}
{%- endif %}
{%- if post_install_remove_packages %}
# Remove custom packages
RUN apk del {{ post_install_remove_packages|join(" ") }}
{%- endif %}
EXPOSE 8000
ENTRYPOINT ["dumb-init", "--"]
CMD ["gunicorn", "--bind=0.0.0.0:8000", "--worker-class=gevent", "--timeout=0", "runtime_http.middleware:wrapped_app"]

