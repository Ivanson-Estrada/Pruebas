"""
Paasify

This module implements the central functionality of the Paasify utility
"""

from . import config
from . import flows
from . import utils


class Paasify:
    """
    The paasify object runs flows on source folders.

    Flows are designed to modify a source folder in order to make it
    ready to be deployed in the BBVA PaaS

    Example:
            >>> paasify = Paasify("/src/base/")
            >>> paasify.run()

    """

    def __init__(self, source_folder, registry):
        self.source_folder = source_folder
        self.registry = registry

    def run(self):
        """
        Run Paasify on a source folder
        """
        # Parse the runtime file
        runtime = utils.get_runtime_contents_as_dict(utils.read_from_source(".runtime.yml", self.source_folder))
        # Get the chosen flavour from the runtime
        flow_id = runtime.get("flavour")
        flow_cls = getattr(flows, config.FLAVOURS.get(flow_id))
        if flow_cls is None:
            raise utils.PaasifyException("Flow {} is not among the supported flows".format(flow_id))
        # Run the flow
        flow = flow_cls(runtime, self.source_folder, self.registry)
        flow.run()
